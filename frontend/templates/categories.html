{% extends "base.html" %}

{% block title %}Categories - Personal Finance App{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h1><i class="bi bi-tags"></i> Categories</h1>
    </div>
    <div class="col-md-6 text-end">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#categoryModal">
            <i class="bi bi-plus-lg"></i> New Category
        </button>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body" id="categories-tree">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Category Info</h5>
            </div>
            <div class="card-body" id="category-info">
                <p class="text-muted">Select a category to view details</p>
            </div>
        </div>
    </div>
</div>

<!-- Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">New Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="category-form">
                    <input type="hidden" id="category-id">
                    
                    <div class="mb-3">
                        <label for="category-name" class="form-label">Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="category-name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="parent-category" class="form-label">Parent Category</label>
                        <select class="form-select" id="parent-category">
                            <option value="">None (Top Level)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="category-icon" class="form-label">Icon</label>
                        <input type="text" class="form-control" id="category-icon" 
                               placeholder="Bootstrap icon name, e.g., basket">
                        <div class="form-text">
                            See <a href="https://icons.getbootstrap.com/" target="_blank">Bootstrap Icons</a>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="category-color" class="form-label">Color</label>
                        <input type="color" class="form-control form-control-color" id="category-color" value="#6c757d">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-category">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this category?</p>
                <p class="text-warning"><i class="bi bi-exclamation-triangle"></i> This will also delete all subcategories. Transactions in this category will become uncategorized.</p>
                <p class="fw-bold" id="delete-category-name"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let categoryModal = null;
    let deleteModal = null;
    let deleteCategoryId = null;
    let allCategories = [];

    document.addEventListener('DOMContentLoaded', function() {
        categoryModal = new bootstrap.Modal(document.getElementById('categoryModal'));
        deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        
        loadCategories();
        
        document.getElementById('save-category').addEventListener('click', saveCategory);
        document.getElementById('confirm-delete').addEventListener('click', deleteCategory);
        
        document.getElementById('categoryModal').addEventListener('hidden.bs.modal', function() {
            document.getElementById('category-form').reset();
            document.getElementById('category-id').value = '';
            document.getElementById('modalTitle').textContent = 'New Category';
        });
    });

    async function loadCategories() {
        try {
            const response = await fetch('/api/categories/hierarchy');
            const categories = await response.json();
            
            // Also get flat list for parent selector
            const flatResponse = await fetch('/api/categories?flat=true');
            allCategories = await flatResponse.json();
            
            renderCategoryTree(categories);
            populateParentSelect();
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }

    function renderCategoryTree(categories, level = 0) {
        const container = document.getElementById('categories-tree');
        if (level === 0) container.innerHTML = '';
        
        categories.forEach(cat => {
            const item = document.createElement('div');
            item.className = 'category-item';
            item.style.paddingLeft = (level * 20) + 'px';
            item.innerHTML = `
                <div class="d-flex align-items-center p-2 border-bottom category-row" data-id="${cat.id}">
                    <span class="me-2" style="color: ${cat.color || '#6c757d'}">
                        <i class="bi bi-${cat.icon || 'tag'}"></i>
                    </span>
                    <span class="flex-grow-1">${escapeHtml(cat.name)}</span>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="editCategory(${cat.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="showDeleteModal(${cat.id}, '${escapeHtml(cat.name)}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(item);
            
            // Add click handler to show info
            item.querySelector('.category-row').addEventListener('click', function(e) {
                if (!e.target.closest('.btn-group')) {
                    showCategoryInfo(cat);
                }
            });
            
            if (cat.children && cat.children.length > 0) {
                cat.children.forEach(child => {
                    renderCategoryTree([child], level + 1);
                });
            }
        });
    }

    function populateParentSelect() {
        const select = document.getElementById('parent-category');
        select.innerHTML = '<option value="">None (Top Level)</option>';
        
        // Only show top-level categories as potential parents
        allCategories.filter(c => !c.parent_id).forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = cat.name;
            select.appendChild(option);
        });
    }

    function showCategoryInfo(category) {
        const container = document.getElementById('category-info');
        container.innerHTML = `
            <p><strong>Name:</strong> ${escapeHtml(category.name)}</p>
            <p><strong>Parent:</strong> ${category.parent_id ? allCategories.find(c => c.id === category.parent_id)?.name || 'Unknown' : 'None'}</p>
            <p><strong>Icon:</strong> <i class="bi bi-${category.icon || 'tag'}"></i> ${category.icon || 'default'}</p>
            <p><strong>Color:</strong> <span style="color: ${category.color || '#6c757d'}">‚óè</span> ${category.color || 'default'}</p>
            <p><strong>Subcategories:</strong> ${category.children?.length || 0}</p>
            <hr>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" onclick="editCategory(${category.id})">
                    <i class="bi bi-pencil"></i> Edit
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="showDeleteModal(${category.id}, '${escapeHtml(category.name)}')">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </div>
        `;
    }

    async function editCategory(id) {
        try {
            const response = await fetch(`/api/categories/${id}`);
            const category = await response.json();
            
            document.getElementById('category-id').value = category.id;
            document.getElementById('category-name').value = category.name;
            document.getElementById('parent-category').value = category.parent_id || '';
            document.getElementById('category-icon').value = category.icon || '';
            document.getElementById('category-color').value = category.color || '#6c757d';
            document.getElementById('modalTitle').textContent = 'Edit Category';
            
            categoryModal.show();
        } catch (error) {
            console.error('Error loading category:', error);
            alert('Error loading category');
        }
    }

    async function saveCategory() {
        const id = document.getElementById('category-id').value;
        const data = {
            name: document.getElementById('category-name').value,
            parent_id: document.getElementById('parent-category').value ? 
                      parseInt(document.getElementById('parent-category').value) : null,
            icon: document.getElementById('category-icon').value || null,
            color: document.getElementById('category-color').value
        };
        
        try {
            const url = id ? `/api/categories/${id}` : '/api/categories';
            const method = id ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                categoryModal.hide();
                loadCategories();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.error || 'Failed to save category'));
            }
        } catch (error) {
            console.error('Error saving category:', error);
            alert('Error saving category');
        }
    }

    function showDeleteModal(id, name) {
        deleteCategoryId = id;
        document.getElementById('delete-category-name').textContent = name;
        deleteModal.show();
    }

    async function deleteCategory() {
        if (!deleteCategoryId) return;
        
        try {
            const response = await fetch(`/api/categories/${deleteCategoryId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                deleteModal.hide();
                loadCategories();
                document.getElementById('category-info').innerHTML = '<p class="text-muted">Select a category to view details</p>';
            } else {
                alert('Error deleting category');
            }
        } catch (error) {
            console.error('Error deleting category:', error);
            alert('Error deleting category');
        }
    }
</script>
<style>
    .category-row:hover {
        background-color: #f8f9fa;
        cursor: pointer;
    }
</style>
{% endblock %}
