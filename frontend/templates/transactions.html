{% extends "base.html" %}

{% block title %}Transactions - Personal Finance App{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h1><i class="bi bi-list-ul"></i> Transactions</h1>
    </div>
    <div class="col-md-6 text-end">
        <a href="/transactions/new" class="btn btn-primary">
            <i class="bi bi-plus-lg"></i> New Transaction
        </a>
        <a href="/import" class="btn btn-outline-secondary">
            <i class="bi bi-upload"></i> Import CSV
        </a>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form id="filter-form" class="row g-3">
            <div class="col-md-2">
                <label for="start-date" class="form-label">Start Date</label>
                <input type="date" class="form-control" id="start-date" name="start_date">
            </div>
            <div class="col-md-2">
                <label for="end-date" class="form-label">End Date</label>
                <input type="date" class="form-control" id="end-date" name="end_date">
            </div>
            <div class="col-md-2">
                <label for="account-filter" class="form-label">Account</label>
                <select class="form-select" id="account-filter" name="account_name">
                    <option value="">All Accounts</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="category-filter" class="form-label">Category</label>
                <select class="form-select" id="category-filter" name="category_id">
                    <option value="">All Categories</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="min-amount" class="form-label">Min Amount</label>
                <input type="number" step="0.01" class="form-control" id="min-amount" name="min_amount">
            </div>
            <div class="col-md-2">
                <label for="max-amount" class="form-label">Max Amount</label>
                <input type="number" step="0.01" class="form-control" id="max-amount" name="max_amount">
            </div>
            <div class="col-md-2">
                <label for="search" class="form-label">Search</label>
                <input type="text" class="form-control" id="search" name="search" placeholder="Description...">
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> Filter
                </button>
                <button type="button" class="btn btn-outline-secondary" id="clear-filters">
                    <i class="bi bi-x-lg"></i> Clear
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Transactions Table -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="transactions-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Merchant</th>
                        <th>Account</th>
                        <th>Category</th>
                        <th class="text-end">Amount</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <nav id="pagination-nav" class="mt-3">
            <ul class="pagination justify-content-center">
            </ul>
        </nav>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this transaction?</p>
                <p class="text-muted" id="delete-transaction-info"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    let deleteTransactionId = null;
    let deleteModal = null;

    document.addEventListener('DOMContentLoaded', function() {
        deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        
        loadCategories();
        loadAccounts();
        loadTransactions();
        
        document.getElementById('filter-form').addEventListener('submit', function(e) {
            e.preventDefault();
            currentPage = 1;
            loadTransactions();
        });
        
        document.getElementById('clear-filters').addEventListener('click', function() {
            document.getElementById('filter-form').reset();
            currentPage = 1;
            loadTransactions();
        });
        
        document.getElementById('confirm-delete').addEventListener('click', function() {
            if (deleteTransactionId) {
                deleteTransaction(deleteTransactionId);
            }
        });
    });

    async function loadCategories() {
        try {
            const response = await fetch('/api/categories?flat=true');
            const categories = await response.json();
            
            const select = document.getElementById('category-filter');
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }

    async function loadAccounts() {
        try {
            const response = await fetch('/api/transactions/accounts');
            const accounts = await response.json();
            
            const select = document.getElementById('account-filter');
            accounts.forEach(account => {
                const option = document.createElement('option');
                option.value = account;
                option.textContent = account;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading accounts:', error);
        }
    }

    async function loadTransactions() {
        const params = new URLSearchParams();
        params.append('page', currentPage);
        params.append('per_page', 25);
        
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        const accountName = document.getElementById('account-filter').value;
        const categoryId = document.getElementById('category-filter').value;
        const minAmount = document.getElementById('min-amount').value;
        const maxAmount = document.getElementById('max-amount').value;
        const search = document.getElementById('search').value;
        
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);
        if (accountName) params.append('account_name', accountName);
        if (categoryId) params.append('category_id', categoryId);
        if (minAmount) params.append('min_amount', minAmount);
        if (maxAmount) params.append('max_amount', maxAmount);
        if (search) params.append('search', search);
        
        try {
            const response = await fetch(`/api/transactions?${params.toString()}`);
            const data = await response.json();
            
            renderTransactions(data.transactions);
            renderPagination(data);
        } catch (error) {
            console.error('Error loading transactions:', error);
        }
    }

    function renderTransactions(transactions) {
        const tbody = document.querySelector('#transactions-table tbody');
        tbody.innerHTML = '';
        
        if (transactions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No transactions found</td></tr>';
            return;
        }
        
        transactions.forEach(txn => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${formatDate(txn.date)}</td>
                <td>${escapeHtml(txn.description)}</td>
                <td>${escapeHtml(txn.merchant || '-')}</td>
                <td><span class="badge bg-info">${escapeHtml(txn.account_name || '-')}</span></td>
                <td><span class="badge bg-secondary">${escapeHtml(txn.category_name || 'Uncategorized')}</span></td>
                <td class="text-end ${txn.amount >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(txn.amount)}</td>
                <td class="text-end">
                    <a href="/transactions/${txn.id}/edit" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-pencil"></i>
                    </a>
                    <button class="btn btn-sm btn-outline-danger" data-txn-id="${txn.id}" data-txn-desc="${escapeHtml(txn.description).replace(/'/g, '&#39;')}" data-txn-amount="${txn.amount}" onclick="showDeleteModalFromButton(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function renderPagination(data) {
        const ul = document.querySelector('#pagination-nav ul');
        ul.innerHTML = '';
        
        if (data.pages <= 1) return;
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${data.page === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${data.page - 1}); return false;">Previous</a>`;
        ul.appendChild(prevLi);
        
        // Page numbers
        for (let i = 1; i <= data.pages; i++) {
            if (i === 1 || i === data.pages || (i >= data.page - 2 && i <= data.page + 2)) {
                const li = document.createElement('li');
                li.className = `page-item ${i === data.page ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a>`;
                ul.appendChild(li);
            } else if (i === data.page - 3 || i === data.page + 3) {
                const li = document.createElement('li');
                li.className = 'page-item disabled';
                li.innerHTML = '<span class="page-link">...</span>';
                ul.appendChild(li);
            }
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${data.page === data.pages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${data.page + 1}); return false;">Next</a>`;
        ul.appendChild(nextLi);
    }

    function goToPage(page) {
        currentPage = page;
        loadTransactions();
    }

    function showDeleteModalFromButton(btn) {
        const id = parseInt(btn.dataset.txnId);
        const description = btn.dataset.txnDesc;
        const amount = parseFloat(btn.dataset.txnAmount);
        showDeleteModal(id, description, amount);
    }

    function showDeleteModal(id, description, amount) {
        deleteTransactionId = id;
        document.getElementById('delete-transaction-info').textContent = 
            `${description} - ${formatCurrency(amount)}`;
        deleteModal.show();
    }

    async function deleteTransaction(id) {
        try {
            const response = await fetch(`/api/transactions/${id}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                deleteModal.hide();
                loadTransactions();
            } else {
                alert('Error deleting transaction');
            }
        } catch (error) {
            console.error('Error deleting transaction:', error);
            alert('Error deleting transaction');
        }
    }
</script>
{% endblock %}
